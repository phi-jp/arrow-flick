var SCREEN_WIDTH=640,SCREEN_HEIGHT=960,SCREEN_CENTER_X=SCREEN_WIDTH/2,SCREEN_CENTER_Y=SCREEN_HEIGHT/2,SCREEN_CENTER=tm.geom.Vector2(SCREEN_CENTER_X,SCREEN_CENTER_Y),SCREEN_RECT=tm.geom.Rect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),TITLE="Flick Arrow",TIME=2e4,PENALTY=2e3,BASE_PATH=window.cordovaFlag?"http://junk.tmlife.net/flick-arrow/":"./",HOME_COLOR="hsl(60, 100%, 50%)",MAIN_FONT="Kaushan Script",BOARD_ID="board_normal",FONT_CODE={play:"0xf04b",home:"0xf015",comment:"0xf075",apple:"0xf179",android:"0xf17b",trophy:"0xf091",gamepad:"0xf11b",shareAlt:"0xf1e0",buysellads:"0xf20d",arrowRight:"0xf061",longArrowRight:"0xf178",handORight:"0xf0a4",angleRight:"0xf106"},QUERY=tm.util.QueryString.parse(location.search.substr(1));QUERY.$safe({scene:"title",level:0});var ASSETS={"images/arrow0":BASE_PATH+"images/arrow0.png","images/arrow1":BASE_PATH+"images/arrow1.png","sounds/bgm":BASE_PATH+"sounds/bgm.wav","sounds/pinpon":BASE_PATH+"sounds/pinpon.mp3","sounds/boo":BASE_PATH+"sounds/boo.mp3"},isNative=function(){return window.cordovaFlag===!0},showAd=function(){window.cordovaFlag&&window.AdMob&&AdMob.prepareInterstitial({adId:admobid.interstitial,autoShow:!0})},clickAdCallback=function(){alert("onInterstitialLeaveApp")};document.addEventListener("onInterstitialLeaveApp",function(){clickAdCallback&&clickAdCallback()}),document.addEventListener("onInterstitialDismiss",function(){});var UserData={init:function(t){var e={life:5,bestScore:0},i=this.get();t?i.$extend(e):i.$safe(e),this.set(i)},get:function(){var t=location.pathname.toCRC32(),e=localStorage.getItem(t);return e?JSON.parse(e):{}},set:function(t){var e=location.pathname.toCRC32(),i=JSON.stringify(t);return localStorage.setItem(e,i),this},hasLife:function(){var t=this.get();return t.life>=1}};!function(){UserData.init()}(),tm.define("CircleButton",{superClass:"tm.display.CanvasElement",init:function(t){this.superInit(),t=t||{},t.$safe({size:150,text:"A",fontFamily:"FontAwesome",fontColor:"white",bgColor:"hsl(180, 60%, 50%)",strokeColor:"transparent",lineWidth:4}),this.fromJSON({children:{bg:{type:"tm.display.Shape",init:{width:t.size,height:t.size}},label:{type:"tm.display.Label",init:t.text,fillStyle:t.fontColor,fontFamily:t.fontFamily,fontSize:t.size/2}}}),this.setInteractive(!0,"circle"),this.on("pointingend",function(){this.flare("push")}),this.fillFlag=t.fillFlag,this.lineWidth=t.lineWidth,this.strokeColor=t.strokeColor,this.bgColor=t.bgColor,this.radius=t.size/2,this._render()},_render:function(){var t=this.bg.canvas;t.setTransformCenter(),t.fillStyle=this.bgColor,t.fillCircle(0,0,this.radius),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeColor,t.strokeCircle(0,0,this.radius-this.lineWidth/2-1)},fill:function(){this.parent.children.each(function(t){t.tweener.clear().fadeOut(200)});this.bg.canvas;this.bg.width=SCREEN_WIDTH,this.bg.height=SCREEN_HEIGHT,this._render(),this.setInteractive(!1),this.label.tweener.clear().fadeOut(200),this.tweener.clear().wait(300).to({x:SCREEN_CENTER_X,y:SCREEN_CENTER_Y},300,"easeOutQuint").to({radius:600},500,"easeOutQuint").call(function(){this.flare("filled")},this),this.update=function(){this._render()}},blink:function(){this.tweener.clear().set({alpha:0}).wait(100).set({alpha:1}).wait(100).set({alpha:0}).wait(100).set({alpha:1}).wait(100).set({alpha:0}).wait(100).set({alpha:1}).wait(100).set({alpha:0}).wait(100).set({alpha:1}).wait(100)}}),tm.define("RankingButton",{superClass:"CircleButton",init:function(t){this.superInit({text:String.fromCharCode(FONT_CODE.trophy),bgColor:"hsl(200, 100%, 50%)"}.$extend(t)),this.on("push",function(){if(window.gamecenter){var t={leaderboardId:BOARD_ID};gamecenter.showLeaderboard(null,null,t)}else console.log("show gamecenter")})}}),tm.define("AdButton",{superClass:"CircleButton",init:function(t){this.superInit({text:String.fromCharCode(FONT_CODE.buysellads),bgColor:"hsl(0, 100%, 64%)"}.$extend(t)),this.on("push",this._showAd)},_showAd:function(){clickAdCallback=function(){this.flare("aded")}.bind(this),showAd()}}),tm.define("ShareButton",{superClass:"CircleButton",init:function(t){this.superInit({text:String.fromCharCode(FONT_CODE.comment),bgColor:"hsl(240, 100%, 64%)"}.$extend(t)),this.message=t.message,this.on("push",this._share)},_share:function(){var t=this.message;if(isNative()){var e={text:t,activityTypes:["PostToFacebook"],activityTypes:["Mail","PostToFacebook","PostToTwitter"],url:"http://gotoapp"};window.socialmessage.send(e),this.flare("shared")}else var i=tm.social.Twitter.createURL({type:"tweet",text:t,hashtags:"FlickArrow,tmlib",url:window.document.location.href}),s=window.open(i,"share window","width=400, height=300"),n=setInterval(function(){s.closed&&(this.flare("shared"),clearInterval(n))}.bind(this),100)}}),tm.define("Life",{superClass:"tm.display.CanvasElement",init:function(){this.superInit();var t=UserData.get();this.backGroup=tm.display.CanvasElement().addChildTo(this),this.frontGroup=tm.display.CanvasElement().addChildTo(this),5..times(function(t){var e=tm.display.HeartShape({width:40,height:40,fillStyle:"gray"}).addChildTo(this.backGroup);e.x=70*t,e.y=0},this),5..times(function(e){var i=tm.display.HeartShape({width:40,height:40}).addChildTo(this.frontGroup);i.x=70*e,i.y=0,i.hide(),t.life>e&&i.show()},this)},decriment:function(){var t=UserData.get();t.life--,UserData.set(t);var e=this.frontGroup.children;e[t.life].tweener.clear().by({y:-100,alpha:-1},200).call(function(){this.flare("decrimented")},this)},recovery:function(){var t=UserData.get(),e=this.frontGroup.children;(5-t.life).times(function(i){var s=e[t.life+i];s.show(),s.alpha=0,s.scale.set(2,2),s.tweener.clear().wait(250*i).to({alpha:1,scaleX:1,scaleY:1},500)},this),t.life=5,UserData.set(t)}}),tm.define("WaveEffect",{superClass:"tm.display.CircleShape",init:function(){this.superInit({fillStyle:"white",strokeStyle:"transparent"}),this.tweener.to({scaleX:2,scaleY:2,alpha:0},250).call(function(){this.remove()},this)}}),tm.define("TitleScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.width=SCREEN_WIDTH,this.height=SCREEN_HEIGHT,this.col=12,this.row=12,this.fromJSON({children:{bg:{type:"tm.display.Shape",init:{width:SCREEN_WIDTH,height:SCREEN_HEIGHT,bgColor:"rgb(248, 248, 248)"},originX:0,originY:0},titleLabel:{type:"tm.display.Label",text:TITLE,fillStyle:"#222",fontFamily:MAIN_FONT,fontSize:112,x:this.gridX(6),y:this.gridY(2)},life:{type:"Life",x:180,y:this.gridY(5)},playButton:{type:"CircleButton",init:{size:this.gridX(3),text:String.fromCharCode(FONT_CODE.play)},x:this.gridX(6),y:this.gridY(7)},shareButton:{type:"ShareButton",init:{size:this.gridX(2),message:"『FlickArrow』矢印をフリックするシンプルなゲームです♪"},x:this.gridX(3),y:this.gridY(9)},rankButton:{type:"RankingButton",init:{size:this.gridX(2)},x:this.gridX(6),y:this.gridY(10)},adButton:{type:"AdButton",init:{size:this.gridX(2)},x:this.gridX(9),y:this.gridY(9)}}});UserData.get();this.playButton.onpush=function(){UserData.hasLife()?(this.life.ondecrimented=function(){this.playButton.fill()}.bind(this),this.life.decriment()):(this.shareButton.blink(),this.adButton.blink())}.bind(this),this.playButton.onfilled=function(){this.app.popScene()}.bind(this),this.adButton.onaded=function(){this.life.recovery()}.bind(this),this.shareButton.onshared=function(){this.life.recovery()}.bind(this)},onenter:function(){CircleFilterEffect({color:HOME_COLOR}).addChildTo(this)},onpointingstart:function(t){var e=t.app.pointing;WaveEffect().addChildTo(this).setPosition(e.x,e.y)},gridX:function(t){return t+=this.col,t%=this.col,this.width/this.col*t},gridY:function(t){return this.height/this.row*t},update:function(t){t.keyboard.getKey("space")&&this.app.popScene()}}),tm.define("GameScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:{shapeGauge:{type:"ShapeGauge"},stage:{type:"tm.display.CanvasElement"},arrowGroup:{type:"tm.display.CanvasElement"},ui:{type:"tm.display.CanvasElement"}}}),this.ui.fromJSON({children:{scoreLabel:{type:"tm.display.Label",x:620,y:40,fillStyle:"#444",fontSize:32,align:"right",text:"00000000"}}}),this.score=0,this.timer=0,this.limitTime=TIME,this.xList=[],this.yList=[],this.setupArrow()},onenter:function(){CircleFilterEffect().addChildTo(this);var t=tm.game.CountScene();this.app.pushScene(t),t.onexit=function(){this.setQuestion()}.bind(this)},createArrow:function(t){var e=["left","right","up","down"].pickup(),i=["blue","blue","red","green"].pickup(),s=Arrow({type:i,direction:e});return s.x=95+110*t,s.y=280,s.scaleX=.4,s.scaleY=.4,s},setupArrow:function(){5..times(function(t){this.createArrow(t).addChildTo(this.arrowGroup)},this)},fillArrow:function(){var t=(this.createArrow(5).addChildTo(this.arrowGroup),this.arrowGroup.children);t.each(function(t,e){t.tweener.clear().to({x:95+110*e,y:280},100)})},getArrow:function(){return this.stage.addChild(this.arrowGroup.children.first)},setQuestion:function(){var t=this.getArrow();t.appear(SCREEN_CENTER_X,SCREEN_CENTER_Y+120),this.arrow=t,this.fillArrow()},update:function(t){var e=this.getFlickDirection(t);this.addTime(t.deltaTime),e||(e=this.getKeyDirection(t)),e&&(this.arrow.check(e)?(this.arrow.disappear(e),this.addScore(1),tm.asset.Manager.get("sounds/pinpon").clone().play(),this.setQuestion()):(this.arrow.move(SCREEN_CENTER_X,SCREEN_CENTER_Y+120),this.arrow.blink(),tm.asset.Manager.get("sounds/boo").clone().play(),this.addTime(PENALTY))),this.isTimeup()&&this.gameover()},gameover:function(){var t=this.app;this.nextLabel="game";var e=ResultScene({score:this.score,bgColor:"rgba(255, 255, 255, 0.95)"});e.onexit=function(){this.nextLabel=e.nextLabel,t.popScene()}.bind(this),t.pushScene(e)},getFlickDirection:function(t){var e=t.pointing;if(e.getPointing()&&(this.xList.push(e.dx),this.xList.length>10&&this.xList.shift(),this.yList.push(e.dy),this.yList.length>10&&this.yList.shift(),this.arrow.x+=.5*e.dx,this.arrow.y+=.5*e.dy),1==e.getPointingEnd()){var i=tm.geom.Vector2();i.x=this.xList.average(),i.y=this.yList.average(),this.xList.clear(),this.yList.clear();var s=i.lengthSquared();if(s>2)return Math.abs(i.x)>Math.abs(i.y)?i.x<0?"left":"right":i.y<0?"up":"down"}return null},getKeyDirection:function(t){var e=t.keyboard;return e.getKeyUp("left")?"left":e.getKeyUp("right")?"right":e.getKeyUp("up")?"up":e.getKeyUp("down")?"down":null},addScore:function(t){this.score+=t,this.ui.scoreLabel.text=this.score.padding(8)},addTime:function(t){this.timer+=t,this.shapeGauge.setValue(this.timer/this.limitTime)},isTimeup:function(){return this.timer>=this.limitTime}}),tm.define("Arrow",{superClass:"tm.display.CircleShape",init:function(t){this.direction=t.direction,this.type=t.type||"blue";var e={red:"hsla(0, 80%, 65%, 1.0)",green:"hsla(120, 80%, 65%, 1.0)",blue:"hsla(240, 80%, 65%, 1.0)"}[this.type];this.superInit({width:256,height:256,strokeStyle:"white",strokeStyle:"transparent",fillStyle:e,lineWidth:8}),this.fromJSON({children:{arrow:{type:"tm.display.Label",init:String.fromCharCode(FONT_CODE.longArrowRight),fontSize:150,fontFamily:"FontAwesome",rotation:{left:180,right:0,up:-90,down:90}[this.direction]}}})},check:function(t){return"blue"==this.type?this.direction==t:"red"==this.type?{left:"right",right:"left",up:"down",down:"up"}[this.direction]==t:"green"==this.type?-1!={left:["up","down"],right:["up","down"],up:["left","right"],down:["left","right"]}[this.direction].indexOf(t):void 0},appear:function(t,e){this.scale.set(.5,.5),this.tweener.clear().to({x:t,y:e,scaleX:1,scaleY:1},500,"easeOutCubic")},disappear:function(t){var e={left:[-1,0],right:[1,0],up:[0,-1],down:[0,1]}[t];this.tweener.clear().by({x:400*e[0],y:400*e[1],alpha:-1},200).call(function(){this.remove()},this)},move:function(t,e){var i=tm.app.Tweener(this).addChildTo(this);i.move(t,e,500,"easeOutElastic").call(function(){i.remove()})},blink:function(){this.tweener.clear().to({scaleX:1,scaleY:1},1e3,"easeOutElastic"),this.tweener.clear(),3..times(function(){this.tweener.set({alpha:0}).wait(30).set({alpha:1}).wait(70)},this)}}),tm.define("CircleFilterEffect",{superClass:"tm.display.Shape",init:function(t){t=t||{},t.$safe({color:"hsl(180, 60%, 50%)"}),this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),this.origin.set(0,0);var e=this.canvas;e.clearColor(t.color),e.setTransformCenter(),this.circleRadius=0,this.tweener.to({circleRadius:1e3})},update:function(){var t=this.canvas;t.globalCompositeOperation="destination-out",t.fillCircle(0,0,this.circleRadius)}}),tm.define("ShapeGauge",{superClass:"tm.display.Shape",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,bgColor:"hsla(0, 0%, 80%, 0.5)"}),this.origin.y=1,this.setPosition(SCREEN_CENTER_X,SCREEN_HEIGHT),this.value=0},update:function(){if(this.value>=.9){var t=1-(1-this.value)/.1,e=100*t,i="hsla(0, {0}%, 80%, 0.5)".format(e);this.bgColor=i}},setValue:function(t){this.value=Math.clamp(t,0,1),this.scaleY=this.value}}),tm.define("FadeScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:{filiter:{type:"tm.display.Shape",init:{width:SCREEN_WIDTH,height:SCREEN_HEIGHT,bgColor:"white",alpha:0},originX:0,originY:0,blendMode:"lighter"}}}),this.filiter.tweener.fadeIn(1e3).wait(500).call(function(){this.app.popScene()},this)}}),tm.define("ResultScene",{superClass:"tm.app.Scene",init:function(t){this.superInit(),t={}.$extend(tm.scene.ResultScene["default"],t),this.param=t;var e=UserData.get(),i=e.bestScore?e.bestScore:0,s=t.score>i;t.record&&s&&(e.bestScore=t.score,UserData.set(e)),this.fromJSON({children:{bg:{type:"tm.display.RectangleShape",init:{width:t.width,height:t.height,fillStyle:t.bgColor,strokeStyle:"transparent"},originX:0,originY:0},stage:{type:"tm.display.CanvasElement"}}});var n={type:"Label",fillStyle:t.fontColor,fontFamily:"'Helvetica-Light' 'Meiryo' sans-serif"},a="SCORE: {score}, {message}".format(t);this.stage.fromJSON({children:{scoreText:n.$extend({text:"score",x:this.gridX(4),y:this.gridY(2),fontSize:.5*t.fontSize}),scoreLabel:{type:"Label",text:t.score,x:this.gridX(4),y:this.gridY(3),fillStyle:t.fontColor,fontSize:t.fontSize,fontFamily:"'Helvetica-Light' 'Meiryo' sans-serif"},bestText:{type:"Label",text:"best",x:this.gridX(8),y:this.gridY(2),fillStyle:t.fontColor,fontSize:.5*t.fontSize,fontFamily:"'Helvetica-Light' 'Meiryo' sans-serif"},bestLabel:{type:"Label",text:i,x:this.gridX(8),y:this.gridY(3),fillStyle:t.fontColor,fontSize:t.fontSize,fontFamily:"'Helvetica-Light' 'Meiryo' sans-serif"},life:{type:"Life",x:180,y:this.gridY(5)},newRecordText:{type:"Label",text:"new record!",x:this.gridX(6),y:this.gridY(4),fillStyle:t.fontColor,fontSize:.5*t.fontSize,fontFamily:"'Helvetica-Light' 'Meiryo' sans-serif",visible:!1},homeButton:{type:"CircleButton",init:{size:this.gridX(3),text:String.fromCharCode(FONT_CODE.home),bgColor:HOME_COLOR},x:this.gridX(6),y:this.gridY(7)},shareButton:{type:"ShareButton",init:{size:this.gridX(2),message:a},x:this.gridX(3),y:this.gridY(9)},rankButton:{type:"RankingButton",init:{size:this.gridX(2)},x:this.gridX(6),y:this.gridY(10)},adButton:{type:"AdButton",init:{size:this.gridX(2)},x:this.gridX(9),y:this.gridY(9)}}});var r=this.stage.life,o=this.stage.homeButton,l=this.stage.shareButton,h=this.stage.adButton;if(o.onpush=function(){o.fill()}.bind(this),o.onfilled=this._toHome.bind(this),h.onaded=function(){r.recovery()}.bind(this),l.onshared=function(){r.recovery()}.bind(this),s&&(this.stage.newRecordText.show(),this.stage.newRecordText.tweener.set({alpha:0}).fadeIn(2e3).setLoop(!0)),this.bg.alpha=0,this.bg.tweener.wait(100).fadeIn(200),this.stage.alpha=0,this.stage.children.each(function(t){t.sleep()}),this.stage.tweener.wait(500).call(function(){this.stage.children.each(function(t){t.wakeUp()})},this).fadeIn(200),window.gamecenter){var c={score:t.score,leaderboardId:BOARD_ID};gamecenter.submitScore(function(){alert("success")},function(){alert("failure")},c)}},gridX:function(t){return this.param.width/12*t},gridY:function(t){return this.param.height/12*t},_toHome:function(){this.nextLabel="title",this.app.popScene()}}),function(){tm.define("tm.game.CountScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:{bg:{type:"tm.display.Shape"},label:{type:"tm.display.Label",fillStyle:"white",fontSize:200,x:SCREEN_CENTER_X,y:SCREEN_CENTER_Y}}}),this.counter=3,this._updateCount()},_updateCount:function(){this.counter<=0;this.label.text=this.counter--,this.label.scale.set(1,1),this.label.tweener.clear().to({scaleX:1,scaleY:1,alpha:1},250).wait(500).to({scaleX:1.5,scaleY:1.5,alpha:0},250).call(function(){this.counter<=0?this.app.popScene():this._updateCount()},this)}})}(),tm.main(function(){var t=tm.display.CanvasApp("#world");t.background="#eee",t.resize(SCREEN_WIDTH,SCREEN_HEIGHT),t.fitWindow();var e=tm.scene.LoadingScene({assets:ASSETS,width:SCREEN_WIDTH,height:SCREEN_HEIGHT});e.onload=function(){t.replaceScene(ManagerScene())},t.replaceScene(e),t.run()}),tm.define("ManagerScene",{superClass:"tm.scene.ManagerScene",init:function(){this.superInit({startLabel:QUERY.scene,scenes:[{className:"TitleScene",label:"title"},{className:"GameScene",label:"game",arguments:{level:QUERY.level},nextLabel:"result"},{className:"ResultScene",label:"result",nextLabel:"title"}]})}});